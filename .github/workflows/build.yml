# Keyball44 カスタムファームウェアビルド
# 公式Yowkees/keyballのワークフローを参考に作成
name: Build Keyball44 Custom Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 手動実行用

jobs:
  build:
    name: Build keyball44:custom
    runs-on: ubuntu-22.04
    # 公式と同じコンテナイメージを使用（SHA256でピン留め）
    container:
      image: ghcr.io/qmk/qmk_cli@sha256:2dc05fc9f32efebd6b05c2b8676ee548358bc7e151e9dbf4dac6b6eed4513b07

    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Checkout qmk_firmware
      uses: actions/checkout@v4
      with:
        path: __qmk__
        repository: qmk/qmk_firmware
        submodules: recursive
        ref: '0.22.14'

    - name: Setup QMK
      run: qmk setup --home __qmk__ --yes

    - name: Clone Keyball source
      run: |
        git clone --depth 1 https://github.com/Yowkees/keyball.git __keyball__
        ln -s $(pwd)/__keyball__/qmk_firmware/keyboards/keyball __qmk__/keyboards/keyball

    - name: Install missing python modules
      run: /usr/bin/python3 -m pip install -r __qmk__/requirements.txt

    - name: Create custom keymap
      run: |
        # viaキーマップをベースにcustomキーマップを作成
        cp -r __qmk__/keyboards/keyball/keyball44/keymaps/via __qmk__/keyboards/keyball/keyball44/keymaps/custom
        # カスタムファイルをコピー
        cp keymap.c __qmk__/keyboards/keyball/keyball44/keymaps/custom/
        cp config.h __qmk__/keyboards/keyball/keyball44/keymaps/custom/
        cp rules.mk __qmk__/keyboards/keyball/keyball44/keymaps/custom/
        # 確認
        ls -la __qmk__/keyboards/keyball/keyball44/keymaps/custom/

    - name: Build firmware
      run: qmk compile -j 4 -kb keyball/keyball44 -km custom

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: keyball44_custom_firmware
        path: __qmk__/*.hex
        if-no-files-found: error
